{% extends "base.html" %}

{% block title %}Results - Blockchain Voting System{% endblock %}

{% block content %}
<div class="container results-container">
    <h1 class="page-title">üìä Election Results</h1>
    
    <!-- Election Selector -->
    <div id="electionSelector" style="margin-bottom: 1.5rem; padding: 1rem; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">
        <label for="electionSelect" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Select Election:</label>
        <select id="electionSelect" class="form-control" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color); background: white;">
            <option value="">Loading elections...</option>
        </select>
    </div>
    
    {% if not system_exists %}
    <div class="alert alert-error">
        <strong>No Election Available</strong><br>
        There are currently no election results to display.
    </div>
    {% else %}
    
    <div class="results-header">
        <h2>{{ stats.election_name }}</h2>
    </div>

    <div class="stats-summary">
        <div class="summary-item">
            <div class="summary-label">Total Votes Cast</div>
            <div class="summary-value">{{ stats.total_votes }}</div>
        </div>
        <div class="summary-item">
            <div class="summary-label">Registered Voters</div>
            <div class="summary-value">{{ stats.total_voters }}</div>
        </div>
        <div class="summary-item">
            <div class="summary-label">Voter Turnout</div>
            <div class="summary-value">{{ stats.turnout }}%</div>
        </div>
    </div>

    {% if candidates %}
    <div class="results-table-container">
        <table class="results-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Candidate</th>
                    <th>Party</th>
                    <th>Votes</th>
                    <th>Percentage</th>
                    <th>Visual</th>
                </tr>
            </thead>
            <tbody>
                {% for candidate in candidates %}
                <tr {% if loop.first %}class="winner-row"{% endif %}>
                    <td class="rank-cell">
                        {% if loop.first %}
                        üèÜ
                        {% else %}
                        {{ loop.index }}
                        {% endif %}
                    </td>
                    <td class="name-cell">{{ candidate.name }}</td>
                    <td class="party-cell">{{ candidate.party }}</td>
                    <td class="votes-cell">{{ candidate.votes }}</td>
                    <td class="percentage-cell">{{ candidate.percentage }}%</td>
                    <td class="visual-cell">
                        <div class="vote-bar">
                            <div class="vote-bar-fill" style="width: {{ candidate.percentage }}%"></div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if candidates[0].votes > 0 %}
    <div class="winner-announcement">
        <div class="winner-icon">üèÜ</div>
        <h2>Winner: {{ candidates[0].name }}</h2>
        <p class="winner-party">{{ candidates[0].party }}</p>
        <p class="winner-stats">{{ candidates[0].votes }} votes ({{ candidates[0].percentage }}%)</p>
    </div>
    {% endif %}

    <!-- Chart -->
    <div class="chart-container">
        <h3>Vote Distribution</h3>
        <canvas id="resultsChart"></canvas>
    </div>

    {% else %}
    <div class="alert alert-info">
        <strong>No Results Yet</strong><br>
        No votes have been cast in this election yet.
    </div>
    {% endif %}

    <div class="blockchain-verification">
        <button id="verifyResultsBtn" class="btn btn-secondary">
            <span>üîí</span> Verify Blockchain Integrity
        </button>
        <div id="verificationResult" style="display: none; margin-top: 1rem;"></div>
    </div>

    <!-- Blockchain Visualization Section -->
    <div class="blockchain-section" style="margin-top: 2rem;">
        <h3 style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
            <span>üîó</span> Blockchain Explorer
            <button id="viewBlockchainBtn" class="btn btn-secondary" style="margin-left: auto; font-size: 0.9rem; padding: 0.5rem 1rem;">
                View Blockchain
            </button>
        </h3>
        <div id="blockchainViewer" style="display: none;">
            <div class="blockchain-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <div class="stat-box" style="background: var(--card-bg); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color);">
                    <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.25rem;">Total Blocks</div>
                    <div id="totalBlocks" style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">-</div>
                </div>
                <div class="stat-box" style="background: var(--card-bg); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color);">
                    <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.25rem;">Pending Votes</div>
                    <div id="pendingVotes" style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">-</div>
                </div>
                <div class="stat-box" style="background: var(--card-bg); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color);">
                    <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.25rem;">Difficulty</div>
                    <div id="difficulty" style="font-size: 1.5rem; font-weight: 700;">-</div>
                </div>
                <div class="stat-box" style="background: var(--card-bg); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color);">
                    <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.25rem;">Chain Status</div>
                    <div id="chainStatus" style="font-size: 1.5rem; font-weight: 700;">-</div>
                </div>
            </div>
            <div id="blockchainBlocks" style="display: flex; flex-direction: column; gap: 1rem;"></div>
        </div>
    </div>

    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Load elections on page load
    async function loadElections() {
        try {
            const response = await fetch('/api/list-elections');
            const result = await response.json();
            if (result.success) {
                const select = document.getElementById('electionSelect');
                select.innerHTML = '';
                
                if (result.elections.length === 0) {
                    select.innerHTML = '<option value="">No elections available</option>';
                } else {
                    result.elections.forEach(election => {
                        const option = document.createElement('option');
                        option.value = election.id;
                        const status = election.is_active ? 'üü¢ Active' : 'üî¥ Closed';
                        option.textContent = `${election.name} - ${status}`;
                        if (election.id === result.current_election_id) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                }
            }
        } catch (error) {
            console.error('Failed to load elections:', error);
        }
    }

    // Switch election
    document.getElementById('electionSelect')?.addEventListener('change', async (e) => {
        const electionId = e.target.value;
        if (!electionId) return;
        
        try {
            const response = await fetch('/api/switch-election', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({election_id: electionId})
            });
            const result = await response.json();
            
            if (result.success) {
                location.reload();
            }
        } catch (error) {
            console.error('Failed to switch election:', error);
        }
    });

    // Load elections when page loads
    loadElections();

    {% if candidates %}
    // Chart data
    const chartData = {
        labels: [{% for candidate in candidates %}'{{ candidate.name }}'{% if not loop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Votes',
            data: [{% for candidate in candidates %}{{ candidate.votes }}{% if not loop.last %}, {% endif %}{% endfor %}],
            backgroundColor: [
                'rgba(99, 102, 241, 0.8)',
                'rgba(139, 92, 246, 0.8)',
                'rgba(236, 72, 153, 0.8)',
                'rgba(251, 146, 60, 0.8)',
                'rgba(34, 197, 94, 0.8)',
            ],
            borderColor: [
                'rgba(99, 102, 241, 1)',
                'rgba(139, 92, 246, 1)',
                'rgba(236, 72, 153, 1)',
                'rgba(251, 146, 60, 1)',
                'rgba(34, 197, 94, 1)',
            ],
            borderWidth: 2
        }]
    };

    // Create chart
    const ctx = document.getElementById('resultsChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
    {% endif %}

    // Verify blockchain
    document.getElementById('verifyResultsBtn')?.addEventListener('click', async () => {
        const btn = document.getElementById('verifyResultsBtn');
        const result = document.getElementById('verificationResult');
        
        btn.disabled = true;
        btn.textContent = 'Verifying...';
        
        try {
            const response = await fetch('/api/verify-blockchain');
            const data = await response.json();
            
            result.style.display = 'block';
            if (data.is_valid) {
                result.className = 'alert alert-success';
                result.innerHTML = '<strong>‚úì Blockchain Verified</strong><br>' + data.message;
            } else {
                result.className = 'alert alert-error';
                result.innerHTML = '<strong>‚úó Verification Failed</strong><br>' + data.message;
            }
        } catch (error) {
            result.style.display = 'block';
            result.className = 'alert alert-error';
            result.innerHTML = '<strong>Error</strong><br>Failed to verify blockchain.';
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<span>üîí</span> Verify Blockchain Integrity';
        }
    });

    // View Blockchain
    document.getElementById('viewBlockchainBtn')?.addEventListener('click', async () => {
        const btn = document.getElementById('viewBlockchainBtn');
        const viewer = document.getElementById('blockchainViewer');
        
        if (viewer.style.display === 'none') {
            btn.disabled = true;
            btn.textContent = 'Loading...';
            
            try {
                const response = await fetch('/api/blockchain-data');
                const data = await response.json();
                
                if (data.success) {
                    // Update stats
                    document.getElementById('totalBlocks').textContent = data.total_blocks;
                    document.getElementById('pendingVotes').textContent = data.pending_transactions.length;
                    document.getElementById('difficulty').textContent = data.difficulty;
                    document.getElementById('chainStatus').innerHTML = data.is_valid 
                        ? '<span style="color: var(--success);">‚úì Valid</span>' 
                        : '<span style="color: var(--error);">‚úó Invalid</span>';
                    
                    // Display blocks
                    const blocksContainer = document.getElementById('blockchainBlocks');
                    blocksContainer.innerHTML = '';
                    
                    data.blocks.forEach((block, index) => {
                        const blockDiv = document.createElement('div');
                        blockDiv.style.cssText = `
                            background: ${index === 0 ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'var(--card-bg)'};
                            padding: 1.5rem;
                            border-radius: 12px;
                            border: 2px solid ${index === 0 ? '#667eea' : 'var(--border-color)'};
                            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                            color: ${index === 0 ? 'white' : 'inherit'};
                        `;
                        
                        let transactionsHtml = '';
                        if (block.transactions.length > 0) {
                            transactionsHtml = `
                                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid ${index === 0 ? 'rgba(255,255,255,0.3)' : 'var(--border-color)'};">
                                    <strong>üìù Transactions (${block.transactions.length}):</strong>
                                    <div style="margin-top: 0.5rem; max-height: 150px; overflow-y: auto;">
                                        ${block.transactions.map(tx => `
                                            <div style="font-size: 0.875rem; padding: 0.25rem 0; opacity: 0.9;">
                                                Voter: ${tx.voter_id} ‚Üí Candidate: ${tx.candidate_id}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }
                        
                        blockDiv.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="font-size: 2rem;">${index === 0 ? 'üèÜ' : 'üîó'}</div>
                                <div>
                                    <div style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.25rem;">
                                        ${index === 0 ? 'Genesis Block' : 'Block #' + block.index}
                                    </div>
                                    <div style="font-size: 0.875rem; opacity: 0.8;">
                                        ${new Date(block.timestamp * 1000).toLocaleString()}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: grid; gap: 0.75rem; font-family: monospace; font-size: 0.875rem;">
                                <div>
                                    <strong style="display: inline-block; width: 140px;">üîë Block Hash:</strong>
                                    <code style="background: ${index === 0 ? 'rgba(0,0,0,0.2)' : 'var(--light)'}; padding: 0.25rem 0.5rem; border-radius: 4px; word-break: break-all; display: inline-block; max-width: calc(100% - 150px);">${block.hash}</code>
                                </div>
                                <div>
                                    <strong style="display: inline-block; width: 140px;">‚¨ÖÔ∏è Previous Hash:</strong>
                                    <code style="background: ${index === 0 ? 'rgba(0,0,0,0.2)' : 'var(--light)'}; padding: 0.25rem 0.5rem; border-radius: 4px; word-break: break-all; display: inline-block; max-width: calc(100% - 150px);">${block.previous_hash}</code>
                                </div>
                                <div style="display: flex; gap: 2rem;">
                                    <div>
                                        <strong>‚õèÔ∏è Nonce:</strong> <code>${block.nonce}</code>
                                    </div>
                                    <div>
                                        <strong>üìä Votes:</strong> <code>${block.transactions.length}</code>
                                    </div>
                                </div>
                            </div>
                            ${transactionsHtml}
                        `;
                        
                        blocksContainer.appendChild(blockDiv);
                        
                        // Add connector arrow if not last block
                        if (index < data.blocks.length - 1) {
                            const arrow = document.createElement('div');
                            arrow.style.cssText = 'text-align: center; font-size: 2rem; margin: -0.5rem 0;';
                            arrow.innerHTML = '‚¨áÔ∏è';
                            blocksContainer.appendChild(arrow);
                        }
                    });
                    
                    // Show pending transactions if any
                    if (data.pending_transactions.length > 0) {
                        const arrow = document.createElement('div');
                        arrow.style.cssText = 'text-align: center; font-size: 2rem; margin: -0.5rem 0;';
                        arrow.innerHTML = '‚¨áÔ∏è';
                        blocksContainer.appendChild(arrow);
                        
                        const pendingDiv = document.createElement('div');
                        pendingDiv.style.cssText = `
                            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
                            padding: 1.5rem;
                            border-radius: 12px;
                            border: 2px solid #fbbf24;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                            color: white;
                        `;
                        pendingDiv.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="font-size: 2rem;">‚è≥</div>
                                <div>
                                    <div style="font-size: 1.25rem; font-weight: 700;">Pending Transactions</div>
                                    <div style="font-size: 0.875rem; opacity: 0.9;">Waiting to be mined</div>
                                </div>
                            </div>
                            <div style="max-height: 150px; overflow-y: auto;">
                                ${data.pending_transactions.map(tx => `
                                    <div style="font-size: 0.875rem; padding: 0.25rem 0; opacity: 0.9;">
                                        Voter: ${tx.voter_id} ‚Üí Candidate: ${tx.candidate_id}
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        blocksContainer.appendChild(pendingDiv);
                    }
                    
                    viewer.style.display = 'block';
                    btn.textContent = 'Hide Blockchain';
                }
            } catch (error) {
                alert('Failed to load blockchain data');
                console.error(error);
            } finally {
                btn.disabled = false;
            }
        } else {
            viewer.style.display = 'none';
            btn.textContent = 'View Blockchain';
        }
    });
</script>
{% endblock %}
